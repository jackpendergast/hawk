<!--
  ============================================================================
  agent.conf  -  Centralized Agent Configuration
  
  This file goes on the MANAGER at:
    /var/ossec/etc/shared/default/agent.conf
  
  It is automatically pushed to all agents in the "default" group.
  This eliminates the need to configure each agent individually.
  
  Restart manager after changes:  sudo systemctl restart wazuh-manager
  ============================================================================
-->
<agent_config>

  <!-- =================================================================
       SYSCHECK (FIM) - FILE INTEGRITY MONITORING
       Detect red team modifications: webshells, backdoors, defacement,
       config changes, persistence mechanisms.
       ================================================================= -->
  <syscheck>
    <disabled>no</disabled>
    <frequency>120</frequency>
    <scan_on_start>yes</scan_on_start>
    <alert_new_files>yes</alert_new_files>
  </syscheck>

</agent_config>

<!-- =================================================================
     LINUX AGENTS
     ================================================================= -->
<agent_config os="Linux">

  <syscheck>
    <!-- Web roots - detect defacement and webshells -->
    <directories realtime="yes" check_sha256="yes">/var/www</directories>
    <directories realtime="yes" check_sha256="yes">/var/www/html</directories>
    <directories realtime="yes" check_sha256="yes">/srv/www</directories>

    <!-- System binaries - detect trojaned replacements -->
    <directories realtime="yes" check_sha256="yes">/usr/bin,/usr/sbin,/bin,/sbin</directories>

    <!-- Auth and identity files -->
    <directories realtime="yes">/etc/passwd,/etc/shadow,/etc/group</directories>
    <directories realtime="yes">/etc/sudoers,/etc/sudoers.d</directories>

    <!-- SSH config and keys (persistence) -->
    <directories realtime="yes">/etc/ssh</directories>
    <directories realtime="yes" restrict=".ssh">/root</directories>

    <!-- Cron jobs (persistence) -->
    <directories realtime="yes">/etc/crontab,/etc/cron.d,/etc/cron.daily,/etc/cron.hourly</directories>
    <directories realtime="yes">/var/spool/cron</directories>

    <!-- Systemd services (persistence) -->
    <directories realtime="yes">/etc/systemd/system</directories>
    <directories realtime="yes">/usr/lib/systemd/system</directories>

    <!-- Mail config (Fedora webmail) -->
    <directories realtime="yes">/etc/postfix</directories>
    <directories realtime="yes">/etc/dovecot</directories>

    <!-- DNS zone files (if hosted on Linux) -->
    <directories realtime="yes">/etc/bind</directories>
    <directories realtime="yes">/var/named</directories>

    <!-- PAM config (auth backdoors) -->
    <directories realtime="yes">/etc/pam.d</directories>

    <!-- Network config -->
    <directories realtime="yes">/etc/hosts,/etc/resolv.conf</directories>
    <directories realtime="yes">/etc/iptables</directories>
    <directories realtime="yes">/etc/nftables.conf</directories>

    <!-- Ignore log noise -->
    <ignore>/var/log</ignore>
    <ignore>/var/ossec/logs</ignore>
    <ignore>/var/ossec/queue</ignore>
    <ignore type="sregex">.log$|.tmp$|.swp$|.journal$</ignore>
  </syscheck>

  <!-- Syscollector - inventory for vulnerability detection -->
  <syscollector>
    <enabled>yes</enabled>
    <interval>5m</interval>
    <scan_on_start>yes</scan_on_start>
    <packages>yes</packages>
    <ports all="yes">yes</ports>
    <processes>yes</processes>
    <network>yes</network>
  </syscollector>

  <!-- Rootcheck -->
  <rootcheck>
    <disabled>no</disabled>
    <frequency>300</frequency>
  </rootcheck>

  <!-- Log collection -->
  <localfile>
    <log_format>syslog</log_format>
    <location>/var/log/auth.log</location>
  </localfile>
  <localfile>
    <log_format>syslog</log_format>
    <location>/var/log/syslog</location>
  </localfile>
  <localfile>
    <log_format>syslog</log_format>
    <location>/var/log/secure</location>
  </localfile>
  <localfile>
    <log_format>apache</log_format>
    <location>/var/log/apache2/access.log</location>
  </localfile>
  <localfile>
    <log_format>apache</log_format>
    <location>/var/log/apache2/error.log</location>
  </localfile>
  <localfile>
    <log_format>apache</log_format>
    <location>/var/log/httpd/access_log</location>
  </localfile>
  <localfile>
    <log_format>apache</log_format>
    <location>/var/log/httpd/error_log</location>
  </localfile>
  <localfile>
    <log_format>syslog</log_format>
    <location>/var/log/mail.log</location>
  </localfile>

  <!-- === COMMAND MONITORING: Service disruption detection === -->

  <!-- Check critical service ports every 60 seconds -->
  <localfile>
    <log_format>full_command</log_format>
    <command>ss -tlnp | grep -cE ':(80|443|25|110|53|21|3306)\s'</command>
    <alias>linux_service_port_count</alias>
    <frequency>60</frequency>
  </localfile>

  <!-- Detect unauthorized SUID binaries -->
  <localfile>
    <log_format>full_command</log_format>
    <command>find / -perm -4000 -type f 2>/dev/null | sort | sha256sum</command>
    <alias>suid_hash_check</alias>
    <frequency>300</frequency>
  </localfile>

  <!-- Check for processes run by unexpected users -->
  <localfile>
    <log_format>full_command</log_format>
    <command>ps -eo user,pid,ppid,cmd --sort=-%cpu | grep -vE '^(root|www-data|postfix|dovecot|named|bind|nobody|syslog|daemon|messagebus|_chrony|wazuh|clamav|USER)' | head -20</command>
    <alias>suspicious_user_processes</alias>
    <frequency>120</frequency>
  </localfile>

  <!-- Check for reverse shells / unusual outbound connections -->
  <localfile>
    <log_format>full_command</log_format>
    <command>ss -tnp state established | grep -vE '(172\.20\.24[02]\.|127\.0\.0\.1|::1)' | grep -v 'sshd' | head -20</command>
    <alias>outbound_connections</alias>
    <frequency>60</frequency>
  </localfile>

  <!-- Check for new cron jobs added -->
  <localfile>
    <log_format>full_command</log_format>
    <command>for u in $(cut -d: -f1 /etc/passwd); do crontab -l -u "$u" 2>/dev/null | grep -v '^#' | grep -v '^$' | sed "s/^/$u: /"; done</command>
    <alias>crontab_audit</alias>
    <frequency>120</frequency>
  </localfile>

  <!-- Check SSH authorized_keys for all users -->
  <localfile>
    <log_format>full_command</log_format>
    <command>find /home /root -name authorized_keys -exec sh -c 'echo "=== {} ==="; cat {}' \; 2>/dev/null | sha256sum</command>
    <alias>ssh_keys_hash</alias>
    <frequency>120</frequency>
  </localfile>

</agent_config>

<!-- =================================================================
     WINDOWS AGENTS
     ================================================================= -->
<agent_config os="Windows">

  <syscheck>
    <!-- Web roots (IIS default) - detect defacement -->
    <directories realtime="yes" check_sha256="yes">C:\inetpub\wwwroot</directories>

    <!-- System32 - detect trojaned system files -->
    <directories realtime="yes" check_sha256="yes">C:\Windows\System32\drivers\etc</directories>

    <!-- Startup locations (persistence) -->
    <directories realtime="yes">C:\Users\*\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup</directories>
    <directories realtime="yes">C:\ProgramData\Microsoft\Windows\Start Menu\Programs\StartUp</directories>

    <!-- Scheduled tasks (persistence) -->
    <directories realtime="yes">C:\Windows\System32\Tasks</directories>

    <!-- PowerShell profiles (persistence) -->
    <directories realtime="yes">C:\Windows\System32\WindowsPowerShell\v1.0</directories>

    <!-- DNS zone files (AD/DNS server) -->
    <directories realtime="yes">C:\Windows\System32\dns</directories>

    <!-- FTP root -->
    <directories realtime="yes">C:\inetpub\ftproot</directories>

    <!-- User directories -->
    <directories realtime="yes">C:\Users</directories>

    <!-- Ignore noise -->
    <ignore>C:\Windows\Temp</ignore>
    <ignore type="sregex">.log$|.tmp$|.etl$</ignore>

    <!-- Registry monitoring (persistence, service tampering) -->
    <windows_registry arch="both">HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Run</windows_registry>
    <windows_registry arch="both">HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\RunOnce</windows_registry>
    <windows_registry>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services</windows_registry>
    <windows_registry>HKEY_LOCAL_MACHINE\Software\Microsoft\Windows NT\CurrentVersion\Winlogon</windows_registry>
    <windows_registry>HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Policies</windows_registry>
  </syscheck>

  <!-- Syscollector -->
  <syscollector>
    <enabled>yes</enabled>
    <interval>5m</interval>
    <scan_on_start>yes</scan_on_start>
    <packages>yes</packages>
    <ports all="yes">yes</ports>
    <processes>yes</processes>
    <network>yes</network>
    <hotfixes>yes</hotfixes>
  </syscollector>

  <!-- Windows Event Channels -->
  <localfile>
    <location>Security</location>
    <log_format>eventchannel</log_format>
    <query>Event/System[EventID != 5145 and EventID != 5156 and EventID != 4689]</query>
  </localfile>
  <localfile>
    <location>System</location>
    <log_format>eventchannel</log_format>
  </localfile>
  <localfile>
    <location>Application</location>
    <log_format>eventchannel</log_format>
  </localfile>
  <localfile>
    <location>Microsoft-Windows-Sysmon/Operational</location>
    <log_format>eventchannel</log_format>
  </localfile>
  <localfile>
    <location>Microsoft-Windows-PowerShell/Operational</location>
    <log_format>eventchannel</log_format>
  </localfile>
  <localfile>
    <location>Microsoft-Windows-Windows Defender/Operational</location>
    <log_format>eventchannel</log_format>
  </localfile>
  <!-- DNS Server logs (for AD/DNS box) -->
  <localfile>
    <location>DNS Server</location>
    <log_format>eventchannel</log_format>
  </localfile>

  <!-- === COMMAND MONITORING: Service disruption detection === -->

  <!-- Check critical Windows services -->
  <localfile>
    <log_format>full_command</log_format>
    <command>powershell -Command "Get-Service W3SVC,DNS,IISADMIN,FTPSVC,WinRM,WazuhSvc -ErrorAction SilentlyContinue | Select Status,Name | ConvertTo-Json -Compress"</command>
    <alias>win_service_check</alias>
    <frequency>60</frequency>
  </localfile>

  <!-- Check for new scheduled tasks (persistence) -->
  <localfile>
    <log_format>full_command</log_format>
    <command>powershell -Command "Get-ScheduledTask | Where-Object {$_.State -eq 'Ready' -and $_.Author -ne 'Microsoft Corporation'} | Select TaskName,Author | ConvertTo-Json -Compress"</command>
    <alias>win_scheduled_tasks</alias>
    <frequency>120</frequency>
  </localfile>

  <!-- Check for suspicious network connections -->
  <localfile>
    <log_format>full_command</log_format>
    <command>powershell -Command "Get-NetTCPConnection -State Established | Where-Object {$_.RemoteAddress -notmatch '^(172\.20\.24|127\.0\.0\.1|::1)'} | Select RemoteAddress,RemotePort,OwningProcess | ConvertTo-Json -Compress"</command>
    <alias>win_outbound_connections</alias>
    <frequency>60</frequency>
  </localfile>

  <!-- Check for new local admin accounts -->
  <localfile>
    <log_format>full_command</log_format>
    <command>powershell -Command "Get-LocalGroupMember -Group 'Administrators' -ErrorAction SilentlyContinue | Select Name,ObjectClass | ConvertTo-Json -Compress"</command>
    <alias>win_local_admins</alias>
    <frequency>120</frequency>
  </localfile>

</agent_config>

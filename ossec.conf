<!--
  ============================================================================
  ossec.conf  -  Wazuh Manager (Ubuntu Wks)
  CCDC-Tuned Configuration
  
  USAGE: After running 01-manager-setup.sh, replace/merge into
         /var/ossec/etc/ossec.conf on the manager box.
         
  Restart after changes:  sudo systemctl restart wazuh-manager
  ============================================================================
-->
<ossec_config>

  <!-- =====================================================================
       GLOBAL SETTINGS
       ===================================================================== -->
  <global>
    <jsonout_output>yes</jsonout_output>
    <alerts_log>yes</alerts_log>
    <logall>yes</logall>
    <logall_json>yes</logall_json>
    <email_notification>no</email_notification>
  </global>

  <!-- =====================================================================
       MANAGER CONNECTION
       The manager listens for agent enrollment and communication.
       ===================================================================== -->
  <auth>
    <use_password>yes</use_password>
    <force>
      <enabled>yes</enabled>
    </force>
  </auth>

  <!-- =====================================================================
       ALERTS  -  Lower threshold to catch more red team activity
       Default is 3; dropping to 1 so we see everything during competition.
       ===================================================================== -->
  <alerts>
    <log_alert_level>1</log_alert_level>
    <email_alert_level>12</email_alert_level>
  </alerts>

  <!-- =====================================================================
       SYSLOG OUTPUT  -  Forward alerts to Splunk (172.20.242.20)
       Splunk must have a TCP input on port 1514 (see splunk/inputs.conf).
       ===================================================================== -->
  <syslog_output>
    <server>172.20.242.20</server>
    <port>9000</port>
    <format>json</format>
    <level>1</level>
  </syslog_output>

  <!-- =====================================================================
       VULNERABILITY DETECTION  -  Find unpatched software on agents
       Helps identify pre-existing weaknesses in the environment.
       ===================================================================== -->
  <vulnerability-detector>
    <enabled>yes</enabled>
    <interval>5m</interval>
    <run_on_start>yes</run_on_start>
    <provider name="canonical">
      <enabled>yes</enabled>
      <os>jammy</os>
      <update_interval>1h</update_interval>
    </provider>
    <provider name="redhat">
      <enabled>yes</enabled>
      <os>9</os>
      <update_interval>1h</update_interval>
    </provider>
    <provider name="msu">
      <enabled>yes</enabled>
      <update_interval>1h</update_interval>
    </provider>
    <provider name="nvd">
      <enabled>yes</enabled>
      <update_interval>1h</update_interval>
    </provider>
  </vulnerability-detector>

  <!-- =====================================================================
       ROOTCHECK  -  Detect rootkits and trojaned system binaries
       Critical for finding pre-existing compromises.
       ===================================================================== -->
  <rootcheck>
    <disabled>no</disabled>
    <check_files>yes</check_files>
    <check_trojans>yes</check_trojans>
    <check_dev>yes</check_dev>
    <check_sys>yes</check_sys>
    <check_pids>yes</check_pids>
    <check_ports>yes</check_ports>
    <check_if>yes</check_if>
    <frequency>300</frequency>
    <rootkit_files>etc/shared/rootkit_files.txt</rootkit_files>
    <rootkit_trojans>etc/shared/rootkit_trojans.txt</rootkit_trojans>
  </rootcheck>

  <!-- =====================================================================
       SCA  -  Security Configuration Assessment
       Checks for misconfigurations that red team could exploit.
       ===================================================================== -->
  <sca>
    <enabled>yes</enabled>
    <scan_on_start>yes</scan_on_start>
    <interval>30m</interval>
  </sca>

  <!-- =====================================================================
       SYSCHECK (FIM)  -  File Integrity Monitoring on the MANAGER itself
       Agent-side FIM is configured in agent.conf (centralized) or
       per-agent ossec.conf.
       ===================================================================== -->
  <syscheck>
    <disabled>no</disabled>
    <frequency>120</frequency>
    <scan_on_start>yes</scan_on_start>
    <alert_new_files>yes</alert_new_files>

    <!-- System binaries - detect trojaned replacements -->
    <directories realtime="yes" check_sha256="yes">/usr/bin,/usr/sbin,/bin,/sbin</directories>

    <!-- Config files - detect persistence mechanisms -->
    <directories realtime="yes" check_sha256="yes">/etc/crontab,/etc/cron.d</directories>
    <directories realtime="yes">/etc/ssh</directories>
    <directories realtime="yes">/etc/passwd,/etc/shadow,/etc/group</directories>
    <directories realtime="yes">/etc/sudoers,/etc/sudoers.d</directories>

    <!-- Wazuh own config - detect tampering -->
    <directories realtime="yes">/var/ossec/etc</directories>

    <!-- Startup scripts -->
    <directories realtime="yes">/etc/systemd/system</directories>
    <directories realtime="yes">/etc/init.d</directories>

    <!-- Ignore noise -->
    <ignore>/var/ossec/logs</ignore>
    <ignore>/var/ossec/queue</ignore>
    <ignore>/var/ossec/var/run</ignore>
    <ignore type="sregex">.log$|.tmp$|.swp$</ignore>
  </syscheck>

  <!-- =====================================================================
       COMMAND MONITORING  -  Detect service disruption & suspicious activity
       These commands run on the MANAGER. Agent commands go in agent.conf.
       ===================================================================== -->

  <!-- Check if critical network services are listening -->
  <localfile>
    <log_format>full_command</log_format>
    <command>ss -tlnp | grep -E ':(80|443|25|110|53|21)\s'</command>
    <alias>service_port_check</alias>
    <frequency>60</frequency>
  </localfile>

  <!-- Check for suspicious processes -->
  <localfile>
    <log_format>full_command</log_format>
    <command>ps aux --sort=-%cpu | head -20</command>
    <alias>top_processes</alias>
    <frequency>120</frequency>
  </localfile>

  <!-- Check for new SUID binaries (privilege escalation) -->
  <localfile>
    <log_format>full_command</log_format>
    <command>find / -perm -4000 -type f 2>/dev/null | sort</command>
    <alias>suid_check</alias>
    <frequency>300</frequency>
  </localfile>

  <!-- Check for unauthorized SSH keys -->
  <localfile>
    <log_format>full_command</log_format>
    <command>find /home -name authorized_keys -exec cat {} + 2>/dev/null; cat /root/.ssh/authorized_keys 2>/dev/null</command>
    <alias>ssh_keys_check</alias>
    <frequency>120</frequency>
  </localfile>

  <!-- Check active network connections (spot reverse shells) -->
  <localfile>
    <log_format>full_command</log_format>
    <command>ss -tnp | grep ESTAB | grep -v '172\.20\.24[02]\.'</command>
    <alias>external_connections</alias>
    <frequency>60</frequency>
  </localfile>

  <!-- =====================================================================
       LOG COLLECTION  -  Gather system logs
       ===================================================================== -->
  <localfile>
    <log_format>syslog</log_format>
    <location>/var/log/syslog</location>
  </localfile>

  <localfile>
    <log_format>syslog</log_format>
    <location>/var/log/auth.log</location>
  </localfile>

  <localfile>
    <log_format>syslog</log_format>
    <location>/var/log/dpkg.log</location>
  </localfile>

  <!-- =====================================================================
       ACTIVE RESPONSE  -  Auto-block attackers
       
       CRITICAL: The scoring engine IPs must be whitelisted.
       The scoring system operates "within the remote network" per the
       team packet. We whitelist the core infrastructure and known 
       scoring ranges. Update these with your actual team number.
       
       Whitelist format: Add IPs that should NEVER be blocked.
       ===================================================================== -->
  <global>
    <!-- SCORING ENGINE / INFRASTRUCTURE - NEVER BLOCK THESE -->
    <!-- Core router gateway -->
    <white_list>172.31.22.1</white_list>
    <!-- VyOS Router external -->
    <white_list>172.31.22.2</white_list>
    <!-- Internal subnets (don't block your own machines) -->
    <white_list>172.20.242.0/24</white_list>
    <white_list>172.20.240.0/24</white_list>
    <!-- Router internal interfaces -->
    <white_list>172.16.101.1</white_list>
    <white_list>172.16.102.1</white_list>
    <!-- Firewall IPs -->
    <white_list>172.16.101.254</white_list>
    <white_list>172.16.102.254</white_list>
    <white_list>172.20.242.254</white_list>
    <white_list>172.20.240.254</white_list>
    <!-- Public IP pool (scoring may come from here) -->
    <!-- UPDATE THIS with your team's public pool once assigned -->
    <white_list>172.25.22.0/24</white_list>
    <!-- Localhost -->
    <white_list>127.0.0.1</white_list>
  </global>

  <!-- Block IPs after repeated SSH brute force -->
  <active-response>
    <command>firewall-drop</command>
    <location>local</location>
    <rules_id>5763</rules_id>
    <timeout>600</timeout>
  </active-response>

  <!-- Block IPs after web attack patterns (SQLi, XSS, etc.) -->
  <active-response>
    <command>firewall-drop</command>
    <location>local</location>
    <rules_id>31104,31105,31106</rules_id>
    <timeout>600</timeout>
  </active-response>

  <!-- Block on repeated authentication failures (any service) -->
  <active-response>
    <command>firewall-drop</command>
    <location>local</location>
    <rules_id>5720</rules_id>
    <timeout>300</timeout>
  </active-response>

  <!-- =====================================================================
       CENTRALIZED AGENT CONFIG (agent.conf)
       This is pushed to all agents automatically.
       See separate file: agents/shared-agent.conf
       ===================================================================== -->

  <!-- =====================================================================
       CUSTOM RULES
       Load our CCDC-specific detection rules.
       ===================================================================== -->
  <ruleset>
    <decoder_dir>etc/decoders</decoder_dir>
    <rule_dir>etc/rules</rule_dir>
    <!-- Our custom rules file -->
    <rule_dir>etc/rules</rule_dir>
    <list>etc/lists/audit-keys</list>
  </ruleset>

</ossec_config>

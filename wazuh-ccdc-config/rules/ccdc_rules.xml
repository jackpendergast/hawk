<!--
  ============================================================================
  ccdc_rules.xml  -  Custom Detection Rules for CCDC
  
  Install to: /var/ossec/etc/rules/ccdc_rules.xml
  
  Then add to ossec.conf inside <ruleset>:
    <include>rules/ccdc_rules.xml</include>
  
  Restart: sudo systemctl restart wazuh-manager
  ============================================================================
  
  Rule ID range: 100100 - 100199 (custom local rules)
-->

<group name="ccdc,">

  <!-- =================================================================
       WEBSHELL DETECTION
       Trigger on new PHP/ASP/JSP files in web directories.
       FIM creates rule 554 (file added), we match on web paths.
       ================================================================= -->

  <rule id="100100" level="14">
    <if_sid>554</if_sid>
    <match type="pcre2">\.php$|\.phtml$|\.php[345]$</match>
    <field name="syscheck.path" type="pcre2">/var/www|/srv/www|/var/html|inetpub|wwwroot</field>
    <description>CCDC: New PHP file in web directory - possible webshell [$(syscheck.path)]</description>
    <group>ccdc_webshell,attack.persistence,</group>
  </rule>

  <rule id="100101" level="14">
    <if_sid>554</if_sid>
    <match type="pcre2">\.asp$|\.aspx$|\.ashx$|\.asmx$</match>
    <field name="syscheck.path" type="pcre2">inetpub|wwwroot</field>
    <description>CCDC: New ASP/ASPX file in IIS web directory - possible webshell [$(syscheck.path)]</description>
    <group>ccdc_webshell,attack.persistence,</group>
  </rule>

  <rule id="100102" level="14">
    <if_sid>554</if_sid>
    <match type="pcre2">\.jsp$|\.jspx$|\.war$</match>
    <field name="syscheck.path" type="pcre2">/var/www|/opt/tomcat|/srv|webapps</field>
    <description>CCDC: New JSP/WAR file in web directory - possible webshell [$(syscheck.path)]</description>
    <group>ccdc_webshell,attack.persistence,</group>
  </rule>

  <!-- =================================================================
       WEB CONTENT MODIFICATION (DEFACEMENT)
       The scoring engine checks that pages match expected content.
       Any modification to index files is critical.
       ================================================================= -->

  <rule id="100103" level="12">
    <if_sid>550,553</if_sid>
    <field name="syscheck.path" type="pcre2">index\.(html?|php|asp|aspx)|default\.(html?|asp|aspx)</field>
    <description>CCDC: Web index file modified - possible defacement [$(syscheck.path)]</description>
    <group>ccdc_defacement,attack.impact,</group>
  </rule>

  <!-- =================================================================
       PERSISTENCE DETECTION
       New cron jobs, systemd services, startup items, SSH keys.
       ================================================================= -->

  <rule id="100110" level="12">
    <if_sid>554</if_sid>
    <field name="syscheck.path" type="pcre2">/etc/cron|/var/spool/cron|/etc/systemd/system|/etc/init\.d</field>
    <description>CCDC: New persistence mechanism detected [$(syscheck.path)]</description>
    <group>ccdc_persistence,attack.persistence,</group>
  </rule>

  <rule id="100111" level="13">
    <if_sid>550,553,554</if_sid>
    <field name="syscheck.path" type="pcre2">authorized_keys</field>
    <description>CCDC: SSH authorized_keys modified or added [$(syscheck.path)]</description>
    <group>ccdc_persistence,attack.persistence,</group>
  </rule>

  <rule id="100112" level="12">
    <if_sid>550,553</if_sid>
    <field name="syscheck.path" type="pcre2">/etc/passwd$|/etc/shadow$</field>
    <description>CCDC: Password/shadow file modified - possible new account or credential change</description>
    <group>ccdc_persistence,attack.persistence,</group>
  </rule>

  <rule id="100113" level="12">
    <if_sid>550,553</if_sid>
    <field name="syscheck.path" type="pcre2">/etc/sudoers</field>
    <description>CCDC: Sudoers modified - possible privilege escalation setup</description>
    <group>ccdc_privesc,attack.privilege_escalation,</group>
  </rule>

  <!-- Windows persistence -->
  <rule id="100114" level="12">
    <if_sid>750,751</if_sid>
    <field name="syscheck.path" type="pcre2">CurrentVersion\\Run|CurrentVersion\\RunOnce</field>
    <description>CCDC: Windows Run key modified - possible persistence [$(syscheck.path)]</description>
    <group>ccdc_persistence,attack.persistence,</group>
  </rule>

  <rule id="100115" level="12">
    <if_sid>554</if_sid>
    <field name="syscheck.path" type="pcre2">Windows\\System32\\Tasks</field>
    <description>CCDC: New Windows scheduled task file - possible persistence [$(syscheck.path)]</description>
    <group>ccdc_persistence,attack.persistence,</group>
  </rule>

  <!-- =================================================================
       SERVICE DISRUPTION
       Detect when critical services stop or configs are tampered with.
       ================================================================= -->

  <rule id="100120" level="13">
    <if_sid>550,553</if_sid>
    <field name="syscheck.path" type="pcre2">/etc/postfix/main\.cf|/etc/dovecot|/etc/mail</field>
    <description>CCDC: Mail service config modified - check SMTP/POP3 scoring [$(syscheck.path)]</description>
    <group>ccdc_service_disruption,</group>
  </rule>

  <rule id="100121" level="13">
    <if_sid>550,553</if_sid>
    <field name="syscheck.path" type="pcre2">/etc/bind|/var/named|/etc/named\.conf</field>
    <description>CCDC: DNS config/zone file modified - check DNS scoring [$(syscheck.path)]</description>
    <group>ccdc_service_disruption,</group>
  </rule>

  <rule id="100122" level="13">
    <if_sid>550,553</if_sid>
    <field name="syscheck.path" type="pcre2">/etc/apache2|/etc/httpd|/etc/nginx</field>
    <description>CCDC: Web server config modified - check HTTP/HTTPS scoring [$(syscheck.path)]</description>
    <group>ccdc_service_disruption,</group>
  </rule>

  <rule id="100123" level="13">
    <if_sid>550,553</if_sid>
    <field name="syscheck.path" type="pcre2">System32\\dns|System32\\inetsrv</field>
    <description>CCDC: Windows DNS/IIS config modified - check service scoring [$(syscheck.path)]</description>
    <group>ccdc_service_disruption,</group>
  </rule>

  <!-- =================================================================
       BINARY REPLACEMENT / TROJAN DETECTION
       System binaries should rarely change. High severity.
       ================================================================= -->

  <rule id="100130" level="14">
    <if_sid>550,553</if_sid>
    <field name="syscheck.path" type="pcre2">^/(usr/)?(bin|sbin)/</field>
    <description>CCDC: System binary modified - possible trojan [$(syscheck.path)]</description>
    <group>ccdc_trojan,attack.persistence,</group>
  </rule>

  <!-- =================================================================
       PAM BACKDOOR DETECTION
       ================================================================= -->

  <rule id="100131" level="14">
    <if_sid>550,553,554</if_sid>
    <field name="syscheck.path" type="pcre2">/etc/pam\.d/|/lib.*security.*pam</field>
    <description>CCDC: PAM config or module modified - possible auth backdoor [$(syscheck.path)]</description>
    <group>ccdc_backdoor,attack.persistence,</group>
  </rule>

  <!-- =================================================================
       BRUTE FORCE ESCALATION
       Fire faster than default rules for competition context.
       ================================================================= -->

  <rule id="100140" level="10" frequency="5" timeframe="60">
    <if_matched_sid>5710</if_matched_sid>
    <description>CCDC: Rapid SSH brute force (5 failures in 60s)</description>
    <group>ccdc_bruteforce,attack.credential_access,</group>
  </rule>

  <rule id="100141" level="10" frequency="5" timeframe="60">
    <if_matched_sid>18100</if_matched_sid>
    <description>CCDC: Rapid Windows logon failures (5 in 60s)</description>
    <group>ccdc_bruteforce,attack.credential_access,</group>
  </rule>

  <!-- =================================================================
       SUSPICIOUS NETWORK ACTIVITY
       Detect reverse shells and C2 connections.
       ================================================================= -->

  <rule id="100150" level="12">
    <if_sid>530</if_sid>
    <match type="pcre2">nc\s+-[le]|ncat\s|socat\s|/dev/tcp|bash\s+-i|python.*socket|perl.*socket</match>
    <description>CCDC: Possible reverse shell command detected</description>
    <group>ccdc_reverseshell,attack.execution,</group>
  </rule>

  <!-- =================================================================
       WINDOWS-SPECIFIC ATTACKS
       ================================================================= -->

  <!-- New local user created -->
  <rule id="100160" level="12">
    <if_sid>60106</if_sid>
    <description>CCDC: New Windows user account created (EventID 4720)</description>
    <group>ccdc_persistence,attack.persistence,</group>
  </rule>

  <!-- User added to privileged group -->
  <rule id="100161" level="14">
    <if_sid>60144</if_sid>
    <description>CCDC: User added to Administrators group (EventID 4732)</description>
    <group>ccdc_privesc,attack.privilege_escalation,</group>
  </rule>

  <!-- Windows service installed -->
  <rule id="100162" level="10">
    <if_sid>60010</if_sid>
    <description>CCDC: New Windows service installed - check for persistence</description>
    <group>ccdc_persistence,attack.persistence,</group>
  </rule>

  <!-- PowerShell suspicious commands -->
  <rule id="100163" level="12">
    <if_sid>91801</if_sid>
    <match type="pcre2">Invoke-Expression|IEX|Invoke-WebRequest|DownloadString|EncodedCommand|-enc\s|-e\s|FromBase64|Net\.WebClient</match>
    <description>CCDC: Suspicious PowerShell execution detected</description>
    <group>ccdc_execution,attack.execution,</group>
  </rule>

</group>
